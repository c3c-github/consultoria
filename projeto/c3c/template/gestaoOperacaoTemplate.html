<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Operações - C3C Workplace</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonte Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        c3c: {
                            blue: '#2978FF',
                            teal: '#1DDDBD',
                            dark: '#1a1a1a',
                            bg: '#F8FAFC'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #F8FAFC; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
        html { scroll-behavior: smooth; }

        /* Estilos Específicos */
        .progress-bar-bg { background-color: #E2E8F0; border-radius: 4px; height: 6px; overflow: hidden; }
        .progress-bar-fill { height: 100%; transition: width 1s ease-in-out; }
        
        /* Barra Segmentada de Alocação */
        .alloc-bar-container { display: flex; height: 8px; width: 100%; background-color: #F1F5F9; border-radius: 4px; overflow: hidden; }
        .alloc-segment { height: 100%; transition: width 0.3s ease; position: relative; }
        .alloc-segment:hover { opacity: 0.8; }
        
        /* Links Laterais */
        .nav-link.active { background-color: #111827; color: white; border-right: 4px solid #1DDDBD; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .nav-link.inactive { color: #9CA3AF; }
        .nav-link.inactive:hover { background-color: #F9FAFB; color: #4B5563; }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-c3c-bg">

    <!-- 1. SIDEBAR -->
    <aside class="w-20 lg:w-64 bg-white border-r border-gray-100 flex flex-col z-20 transition-all duration-300">
        <div class="h-20 flex items-center justify-center lg:justify-start lg:px-8 border-b border-gray-50">
            <div class="w-8 h-8 bg-gradient-to-br from-[#2978FF] to-[#1DDDBD] rounded-lg flex items-center justify-center text-white font-bold text-xs">C3C</div>
            <span class="hidden lg:block ml-3 font-bold text-gray-800 tracking-wide text-lg">Workplace</span>
        </div>
        <nav class="flex-1 py-6 space-y-2">
            <a href="#dashboard-top" class="nav-link active w-full flex items-center justify-center lg:justify-start gap-3 px-4 lg:px-6 py-3 transition-colors" onclick="setActiveLink(this)">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
                <span class="hidden lg:block text-sm">Visão Geral</span>
            </a>
            <a href="#contracts-section" class="nav-link inactive w-full flex items-center justify-center lg:justify-start gap-3 px-4 lg:px-6 py-3 transition-colors" onclick="setActiveLink(this)">
                <i data-lucide="briefcase" class="w-5 h-5"></i>
                <span class="hidden lg:block text-sm">Contratos & Ops</span>
            </a>
            <a href="#team-section" class="nav-link inactive w-full flex items-center justify-center lg:justify-start gap-3 px-4 lg:px-6 py-3 transition-colors" onclick="setActiveLink(this)">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span class="hidden lg:block font-medium text-sm">Equipe</span>
            </a>
            <a href="#allocation-section" class="nav-link inactive w-full flex items-center justify-center lg:justify-start gap-3 px-4 lg:px-6 py-3 transition-colors" onclick="setActiveLink(this)">
                <i data-lucide="sliders" class="w-5 h-5"></i>
                <span class="hidden lg:block font-medium text-sm">Alocação</span>
            </a>
        </nav>
        
        <div class="p-4 border-t border-gray-100 bg-gray-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold border-2 border-white shadow-sm">GT</div>
                <div class="hidden lg:block overflow-hidden">
                    <p class="text-sm font-bold text-gray-800 truncate">Gustavo Torres</p>
                    <p class="text-xs text-gray-500 truncate">Head de Operações</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- 2. MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative w-full overflow-hidden">
        
        <!-- Header -->
        <header class="h-20 bg-white border-b border-gray-200 flex items-center justify-between px-8 shrink-0 z-10">
            <div class="flex items-center gap-6">
                <h1 class="text-xl font-bold text-gray-800">Command Center</h1>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center bg-white border border-gray-300 rounded-lg px-3 py-2 gap-2 shadow-sm">
                    <i data-lucide="calendar" class="w-4 h-4 text-gray-500"></i>
                    <select class="text-sm font-bold text-gray-700 bg-transparent outline-none cursor-pointer">
                        <option>Dezembro 2024</option>
                        <option>Janeiro 2025</option>
                    </select>
                </div>
                <button class="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors relative">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                </button>
            </div>
        </header>

        <!-- Content Scrollable -->
        <div class="flex-1 overflow-y-auto p-8 fade-in relative" id="dashboard-top">
            
            <!-- KPIS GLOBAIS -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
                <!-- Financeiro -->
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-start z-10 relative">
                        <p class="text-xs font-bold text-gray-400 uppercase">Saúde Contratos</p>
                        <i data-lucide="pie-chart" class="w-5 h-5 text-blue-500"></i>
                    </div>
                    <div class="mt-2 z-10 relative">
                        <span class="text-2xl font-extrabold text-gray-900">75%</span>
                        <span class="text-xs text-gray-500">consumido</span>
                    </div>
                    <div class="absolute bottom-0 left-0 w-full h-1 bg-blue-100"><div class="bg-blue-500 h-1" style="width: 75%"></div></div>
                </div>

                <!-- SLA Operacional -->
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-start">
                        <p class="text-xs font-bold text-gray-400 uppercase">SLA Estourado</p>
                        <i data-lucide="alert-octagon" class="w-5 h-5 text-red-500"></i>
                    </div>
                    <div class="mt-2">
                        <span class="text-2xl font-extrabold text-red-600">8</span>
                        <span class="text-xs text-gray-500">Chamados críticos</span>
                    </div>
                </div>

                <!-- Estagnação -->
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-start">
                        <p class="text-xs font-bold text-gray-400 uppercase">Estagnados > 3 dias</p>
                        <i data-lucide="clock" class="w-5 h-5 text-orange-500"></i>
                    </div>
                    <div class="mt-2">
                        <span class="text-2xl font-extrabold text-orange-600">5</span>
                        <span class="text-xs text-gray-500">Sem interação recente</span>
                    </div>
                </div>

                <!-- CSAT -->
                <div class="bg-white p-5 rounded-xl border border-teal-50 shadow-sm">
                    <div class="flex justify-between items-start">
                        <p class="text-xs font-bold text-teal-600 uppercase">CSAT Médio</p>
                        <i data-lucide="smile" class="w-5 h-5 text-teal-500"></i>
                    </div>
                    <div class="mt-2">
                        <span class="text-2xl font-extrabold text-teal-700">4.8</span>
                        <span class="text-xs text-teal-600">/ 5.0</span>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 1: CONTRATOS & OPERAÇÃO -->
            <div id="contracts-section" class="mb-12 scroll-mt-24">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="briefcase" class="w-5 h-5 text-blue-600"></i> Performance de Contratos & Operação
                    </h2>
                </div>
                
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 uppercase text-[10px] font-bold border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-4 min-w-[200px]">Cliente / Serviço</th>
                                <th class="px-4 py-4 min-w-[120px]">Horas (Uso)</th>
                                <!-- Fila Detalhada -->
                                <th class="px-2 py-4 text-center w-12 bg-blue-50/50 text-blue-600 border-l border-white" title="Abertos">Ab.</th>
                                <th class="px-2 py-4 text-center w-12 bg-blue-50/50 text-blue-600 border-l border-white" title="Execução">Exe.</th>
                                <th class="px-2 py-4 text-center w-12 bg-yellow-50/50 text-yellow-600 border-l border-white" title="Pausa">Pau.</th>
                                <th class="px-2 py-4 text-center w-12 bg-yellow-50/50 text-yellow-600 border-l border-white" title="Aguardando">Ag.</th>
                                <th class="px-2 py-4 text-center w-12 bg-gray-50 text-gray-400 border-l border-white" title="Fechados">Fec.</th>
                                
                                <!-- Métricas de Qualidade -->
                                <th class="px-4 py-4 text-center border-l border-gray-100 text-red-600" title="SLA Estourado">SLA KO</th>
                                <th class="px-4 py-4 text-center text-orange-500" title="Tempo sem interação">Estag.</th>
                                <th class="px-4 py-4 text-center text-teal-600">CSAT</th>

                                <th class="px-4 py-4 text-center border-l border-gray-100">Time</th>
                                <th class="px-4 py-4 text-right">Ação</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100" id="contracts-table">
                            <!-- JS Populates -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SEÇÃO 2: EQUIPE -->
            <div id="team-section" class="mb-12 scroll-mt-24">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="users" class="w-5 h-5 text-indigo-600"></i> Monitoramento da Equipe
                    </h2>
                    
                    <div class="flex gap-3 bg-white px-3 py-1.5 rounded-lg border border-gray-200 text-[10px] font-medium shadow-sm">
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-red-500"></div> Atrasado (>1 dia)</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-yellow-400"></div> Pendente Hoje</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-green-500"></div> Em Dia</span>
                    </div>
                </div>

                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 uppercase text-xs font-bold border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-4 w-64">Colaborador</th>
                                <th class="px-6 py-4 text-center">Projetos</th>
                                <th class="px-6 py-4 text-center">Apontado Hoje</th>
                                <th class="px-6 py-4">Carga Mensal (Realizado vs Previsto)</th>
                                <th class="px-6 py-4 text-center">Status</th>
                                <th class="px-6 py-4 text-right">Detalhes</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100" id="team-table-body">
                            <!-- JS Populates -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SEÇÃO 3: GERENCIAMENTO DE ALOCAÇÃO -->
            <div id="allocation-section" class="mb-8 scroll-mt-24">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="sliders" class="w-5 h-5 text-gray-600"></i> Distribuição de Capacidade
                    </h2>
                    <p class="text-xs text-gray-500 bg-white px-3 py-1 rounded border border-gray-200">Visão percentual por recurso</p>
                </div>

                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 uppercase text-xs font-bold border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-4 w-64">Colaborador</th>
                                <th class="px-6 py-4">Distribuição (%)</th>
                                <th class="px-6 py-4 text-center w-32">Total Alocado</th>
                                <th class="px-6 py-4 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100" id="allocation-table-body">
                            <!-- JS Populates -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- MODAIS -->

    <!-- 1. Modal Extrato do Contrato -->
    <div id="extract-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[80vh] flex flex-col transform scale-95 transition-transform duration-300">
            <div class="p-6 border-b border-gray-100 flex justify-between items-start bg-gray-50 rounded-t-xl">
                <div>
                    <h3 class="text-xl font-bold text-gray-900" id="modal-title">Detalhe do Lançamento</h3>
                    <p class="text-sm text-gray-500" id="modal-subtitle">Histórico de Atividades</p>
                </div>
                <button onclick="closeModal('extract-modal')" class="bg-white hover:bg-gray-100 p-2 rounded-lg text-gray-500 border border-gray-200 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-gray-50 text-gray-500 font-bold border-b border-gray-200 uppercase">
                            <tr>
                                <th class="px-4 py-3 w-32">Data</th>
                                <th class="px-4 py-3 w-48">Cliente</th>
                                <th class="px-4 py-3 w-48">Serviço</th>
                                <th class="px-4 py-3">Atividade / Descrição</th>
                                <th class="px-4 py-3 text-right w-24">Horas</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100" id="modal-rows"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Modal de Edição de Alocação -->
    <div id="allocation-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform scale-95 transition-transform duration-300">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                <div>
                    <h3 class="font-bold text-gray-900 text-lg">Editar Alocações</h3>
                    <p class="text-xs text-gray-500" id="alloc-modal-name">Nome do Recurso</p>
                </div>
                <button onclick="closeModal('allocation-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div class="mb-4 flex justify-between items-center bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <span class="text-xs font-bold text-blue-700 uppercase">Total Alocado:</span>
                    <span class="text-lg font-bold text-blue-700" id="alloc-total-display">100%</span>
                </div>
                <div id="alloc-inputs-container" class="space-y-4"></div>
                
                <!-- Botão Adicionar Projeto -->
                <button onclick="addAllocationRow()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded-lg text-xs font-bold hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> Adicionar novo projeto
                </button>
            </div>
            <div class="p-5 border-t border-gray-100 bg-gray-50 rounded-b-xl flex justify-end gap-2">
                <button onclick="closeModal('allocation-modal')" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-bold rounded-lg hover:bg-gray-100">Cancelar</button>
                <button onclick="saveAllocations()" class="px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-lg hover:bg-blue-700 shadow-md">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <!-- 3. Modal Lista de Projetos -->
    <div id="projects-list-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 transform scale-95 transition-transform duration-300">
            <h3 class="font-bold text-gray-800 mb-4">Projetos Ativos</h3>
            <ul class="space-y-2 text-sm text-gray-600" id="projects-list-content"></ul>
            <div class="mt-6 text-right"><button onclick="closeModal('projects-list-modal')" class="text-sm font-bold text-gray-500 hover:text-gray-800">Fechar</button></div>
        </div>
    </div>

    <!-- 4. Modal Equipe do Contrato -->
    <div id="contract-team-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800">Equipe Alocada</h3>
                <button onclick="closeModal('contract-team-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <p class="text-xs text-gray-500 mb-4" id="contract-team-title">Contrato X</p>
            <div id="contract-team-list" class="space-y-3">
                <!-- JS Populates -->
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- DADOS MOCK ---
        const contracts = [
            { id: 1, name: "Sustentação Salesforce N2", client: "Tech Solutions", total: 200, used: 185, open: 12, inProg: 5, pause: 2, waiting: 5, closed: 45, teamCount: 3, slaBreach: 2, idleTime: "14h", csat: 4.8 },
            { id: 2, name: "Infraestrutura Cloud", client: "Banco Alpha", total: 160, used: 80, open: 3, inProg: 2, pause: 0, waiting: 8, closed: 22, teamCount: 2, slaBreach: 0, idleTime: "2h", csat: 5.0 },
            { id: 3, name: "Consultoria Power BI", client: "Varejo Express", total: 80, used: 78, open: 5, inProg: 3, pause: 1, waiting: 1, closed: 10, teamCount: 1, slaBreach: 1, idleTime: "3 dias", csat: 3.5 }
        ];

        const resources = [
            { 
                id: 1, name: "Maria Costa", role: "Salesforce Sr.", 
                allocations: [ { name: "Salesforce N2", pct: 70 }, { name: "Squad Alpha", pct: 30 } ],
                hoursToday: 8.0, hoursMonth: 140, contractMonth: 168, expectedToDate: 144
            },
            { 
                id: 2, name: "João Silva", role: "Dev Pleno", 
                allocations: [ { name: "Salesforce N2", pct: 50 }, { name: "Projeto Beta", pct: 20 }, { name: "Projeto Gama", pct: 20 }, { name: "Interno", pct: 10 } ], 
                hoursToday: 4.0, hoursMonth: 144, contractMonth: 168, expectedToDate: 144 
            },
            { 
                id: 3, name: "Pedro Lima", role: "Suporte N1", 
                allocations: [ { name: "Salesforce N2", pct: 100 } ],
                hoursToday: 0, hoursMonth: 100, contractMonth: 168, expectedToDate: 144 
            }
        ];

        // --- RENDERIZAR CONTRATOS ---
        function renderContracts() {
            const tbody = document.getElementById('contracts-table');
            tbody.innerHTML = '';
            contracts.forEach(c => {
                const percent = (c.used / c.total) * 100;
                let barColor = percent > 90 ? 'bg-red-500' : (percent > 75 ? 'bg-yellow-500' : 'bg-blue-500');
                
                // Formatação Operacional
                let slaColor = c.slaBreach > 0 ? 'text-red-600 font-bold' : 'text-gray-400';
                let idleColor = c.idleTime.includes('dias') ? 'text-orange-600 font-bold' : 'text-gray-500';
                let csatColor = c.csat >= 4.5 ? 'text-teal-600 font-bold' : (c.csat < 4.0 ? 'text-red-600 font-bold' : 'text-yellow-600');

                tbody.innerHTML += `
                <tr class="hover:bg-gray-50 transition-colors group border-b border-gray-100">
                    <td class="px-6 py-4">
                        <p class="font-bold text-gray-800 text-sm">${c.name}</p>
                        <p class="text-xs text-gray-500">${c.client}</p>
                    </td>
                    <td class="px-4 py-4 align-middle">
                        <div class="flex justify-between text-xs mb-1 font-medium"><span>${c.used}h</span><span class="text-gray-400">de ${c.total}h</span></div>
                        <div class="progress-bar-bg"><div class="progress-bar-fill ${barColor}" style="width: ${percent}%"></div></div>
                    </td>
                    <td class="px-2 py-4 text-center text-xs font-bold text-blue-600 bg-blue-50/30 border-r border-white">${c.open}</td>
                    <td class="px-2 py-4 text-center text-xs font-medium text-blue-600 bg-blue-50/30 border-r border-white">${c.inProg}</td>
                    <td class="px-2 py-4 text-center text-xs font-medium text-yellow-600 bg-yellow-50/30 border-r border-white">${c.pause}</td>
                    <td class="px-2 py-4 text-center text-xs font-bold text-yellow-600 bg-yellow-50/30 border-r border-white">${c.waiting}</td>
                    <td class="px-2 py-4 text-center text-xs text-gray-400 bg-gray-50/30">${c.closed}</td>
                    
                    <td class="px-4 py-4 text-center ${slaColor}">${c.slaBreach}</td>
                    <td class="px-4 py-4 text-center text-xs ${idleColor}">${c.idleTime}</td>
                    <td class="px-4 py-4 text-center text-sm ${csatColor}">${c.csat}</td>

                    <td class="px-4 py-4 text-center">
                        <button onclick="openContractTeam(${c.id})" class="text-xs font-bold text-blue-600 hover:underline bg-blue-50 px-2 py-1 rounded border border-blue-100">
                            ${c.teamCount} Pessoas
                        </button>
                    </td>
                    <td class="px-4 py-4 text-right"><button onclick="openExtract('${c.name}')" class="text-xs font-bold text-indigo-600 hover:underline">Extrato</button></td>
                </tr>`;
            });
        }

        // --- RENDERIZAR EQUIPE ---
        function renderTeam() {
            const tbody = document.getElementById('team-table-body');
            tbody.innerHTML = '';
            
            resources.forEach(r => {
                const projectsLink = `<button onclick="openProjectsList('${r.name}', ${r.id})" class="text-blue-600 font-bold hover:underline text-xs bg-blue-50 px-2 py-1 rounded border border-blue-100 shadow-sm">${r.allocations.length} Projetos</button>`;
                
                let today = r.hoursToday === 0 ? `<span class="flex items-center justify-center gap-1 text-xs text-red-500 font-bold bg-red-50 px-2 py-1 rounded">Pendente</span>` : 
                            (r.hoursToday < 8 ? `<span class="flex items-center justify-center gap-1 text-xs text-yellow-600 font-bold">${r.hoursToday}h</span>` : `<span class="flex items-center justify-center gap-1 text-xs text-green-600 font-bold">${r.hoursToday}h</span>`);

                const monthPercent = Math.min((r.hoursMonth / r.contractMonth) * 100, 100);
                let statusColor = 'bg-green-500'; 
                let statusText = 'Em Dia';
                
                if (r.hoursMonth < r.expectedToDate - 8) {
                    statusColor = 'bg-red-500'; statusText = 'Atrasado';
                } else if (r.hoursMonth < r.expectedToDate) {
                    statusColor = 'bg-yellow-400'; statusText = 'Pendente Hoje';
                }

                tbody.innerHTML += `
                <tr class="hover:bg-gray-50 transition-colors border-b border-gray-100">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600 border border-gray-300">${r.name.charAt(0)}</div>
                            <div><p class="font-bold text-gray-900 text-sm">${r.name}</p><p class="text-xs text-gray-500">${r.role}</p></div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">${projectsLink}</td>
                    <td class="px-6 py-4 text-center">${today}</td>
                    <td class="px-6 py-4 align-middle">
                        <div class="flex justify-between text-xs mb-1 font-medium">
                            <span class="${statusColor.replace('bg-','text-')} font-bold">${r.hoursMonth}h</span>
                            <span class="text-gray-400">Meta Hoje: ${r.expectedToDate}h</span>
                        </div>
                        <div class="progress-bar-bg relative">
                            <div class="absolute top-0 bottom-0 w-0.5 bg-gray-400 z-10" style="left: ${(r.expectedToDate/r.contractMonth)*100}%" title="Meta Hoje"></div>
                            <div class="progress-bar-fill ${statusColor}" style="width: ${monthPercent}%"></div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center gap-1 text-[10px] uppercase font-bold text-gray-600 bg-gray-100 px-2 py-1 rounded">
                            <div class="w-2 h-2 rounded-full ${statusColor}"></div> ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right"><button onclick="openExtract('${r.name} - Detalhes')" class="text-xs font-bold text-indigo-600 hover:underline">Ver Detalhes</button></td>
                </tr>`;
            });
        }

        // --- RENDERIZAR ESCALA (Barra Visual) ---
        function renderScale() {
            const tbody = document.getElementById('allocation-table-body');
            tbody.innerHTML = '';
            resources.forEach(r => {
                let totalAlloc = 0;
                let segmentsHtml = '';
                const colors = ['bg-blue-500', 'bg-teal-500', 'bg-purple-500', 'bg-orange-500', 'bg-pink-500'];
                
                r.allocations.forEach((a, index) => {
                    totalAlloc += a.pct;
                    segmentsHtml += `<div class="alloc-segment ${colors[index % colors.length]}" style="width: ${a.pct}%" title="${a.name} (${a.pct}%)"></div>`;
                });

                let totalColor = totalAlloc > 100 ? 'text-red-600' : (totalAlloc < 80 ? 'text-yellow-600' : 'text-green-600');

                tbody.innerHTML += `
                <tr class="hover:bg-gray-50 border-b border-gray-100">
                    <td class="px-6 py-4 align-middle">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-600">${r.name.charAt(0)}</div>
                            <div><p class="font-bold text-gray-900 text-sm">${r.name}</p><p class="text-xs text-gray-500">${r.role}</p></div>
                        </div>
                    </td>
                    <td class="px-6 py-4 align-middle">
                        <div class="alloc-bar-container mb-1">${segmentsHtml}</div>
                        <div class="flex gap-2 text-[9px] text-gray-400 overflow-hidden h-4">
                            ${r.allocations.map(a => `<span class="truncate">${a.name}</span>`).join('<span class="mx-1">•</span>')}
                        </div>
                    </td>
                    <td class="px-6 py-4 align-middle text-center"><span class="text-sm font-bold ${totalColor}">${totalAlloc}%</span></td>
                    <td class="px-6 py-4 align-middle text-right">
                        <button onclick="openAllocationModal(${r.id})" class="text-xs bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded hover:bg-gray-50 shadow-sm font-bold">Gerenciar</button>
                    </td>
                </tr>`;
            });
        }

        // --- MODAIS ---
        
        function openExtract(title) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-subtitle').innerText = "Histórico Detalhado";
            
            const tbody = document.getElementById('modal-rows');
            tbody.innerHTML = `
                <tr class="border-b border-gray-50"><td class="px-4 py-3 text-gray-500">22/12/2024</td><td class="px-4 py-3 font-bold text-gray-700">Tech Solutions</td><td class="px-4 py-3 text-gray-600">Salesforce N2</td><td class="px-4 py-3 text-gray-800">Atendimento Ticket #405</td><td class="px-4 py-3 text-right font-mono font-bold text-blue-600">4.0h</td></tr>
                <tr class="border-b border-gray-50"><td class="px-4 py-3 text-gray-500">21/12/2024</td><td class="px-4 py-3 font-bold text-gray-700">Tech Solutions</td><td class="px-4 py-3 text-gray-600">Salesforce N2</td><td class="px-4 py-3 text-gray-800">Reunião Daily</td><td class="px-4 py-3 text-right font-mono font-bold text-blue-600">1.0h</td></tr>
            `;
            openModal('extract-modal');
        }

        // 2. Modal Equipe do Contrato (Novo)
        function openContractTeam(id) {
            const contract = contracts.find(c => c.id === id);
            document.getElementById('contract-team-title').innerText = contract.name;
            const list = document.getElementById('contract-team-list');
            list.innerHTML = '';
            
            // Simular busca de pessoas neste contrato
            // Na vida real faria um filter no array resources
            const members = resources.filter(r => r.allocations.some(a => a.name.includes(contract.name.split(' ')[1]))); // Match "Salesforce" etc.
            
            if(members.length === 0) list.innerHTML = '<p class="text-sm text-gray-400">Ninguém alocado.</p>';
            
            members.forEach(m => {
                const alloc = m.allocations.find(a => a.name.includes(contract.name.split(' ')[1]));
                list.innerHTML += `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-xs font-bold text-indigo-700">${m.name.charAt(0)}</div>
                        <div><p class="text-sm font-bold text-gray-800">${m.name}</p><p class="text-[10px] text-gray-500">${m.role}</p></div>
                    </div>
                    <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">${alloc ? alloc.pct : '?'}%</span>
                </div>`;
            });
            openModal('contract-team-modal');
        }

        function openProjectsList(name, id) {
            const res = resources.find(r => r.id === id);
            const list = document.getElementById('projects-list-content');
            list.innerHTML = '';
            res.allocations.forEach(a => {
                list.innerHTML += `<li class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100"><span>${a.name}</span><span class="font-bold text-blue-600">${a.pct}%</span></li>`;
            });
            openModal('projects-list-modal');
        }

        function openAllocationModal(id) {
            const res = resources.find(r => r.id === id);
            document.getElementById('alloc-modal-name').innerText = res.name;
            const container = document.getElementById('alloc-inputs-container');
            container.innerHTML = '';
            
            res.allocations.forEach(a => {
                container.innerHTML += `
                <div class="flex items-center gap-3 bg-white p-3 rounded border border-gray-200 shadow-sm alloc-row">
                    <div class="flex-1">
                        <p class="text-xs font-bold text-gray-700 mb-1">Projeto</p>
                        <input type="text" value="${a.name}" class="w-full text-sm border-none bg-transparent font-medium p-0 focus:ring-0">
                    </div>
                    <div class="w-24">
                        <p class="text-[10px] font-bold text-gray-400 mb-1">Percentual</p>
                        <div class="flex items-center border border-gray-300 rounded overflow-hidden">
                            <input type="number" value="${a.pct}" class="w-full text-center text-sm p-1 border-none focus:ring-0 font-bold text-blue-600">
                            <span class="bg-gray-100 text-xs px-2 py-1 text-gray-500 font-bold border-l border-gray-300">%</span>
                        </div>
                    </div>
                    <button class="text-gray-400 hover:text-red-500 p-2" onclick="this.parentElement.remove()"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`;
            });
            lucide.createIcons();
            openModal('allocation-modal');
        }

        function addAllocationRow() {
            const container = document.getElementById('alloc-inputs-container');
            container.innerHTML += `
            <div class="flex items-center gap-3 bg-white p-3 rounded border border-gray-200 shadow-sm alloc-row fade-in">
                <div class="flex-1">
                    <p class="text-xs font-bold text-gray-700 mb-1">Novo Projeto</p>
                    <select class="w-full text-sm border border-gray-300 rounded p-1 bg-white focus:ring-2 focus:ring-blue-500">
                        <option value="" disabled selected>Selecione...</option>
                        <option>Sustentação Salesforce N2</option>
                        <option>Infraestrutura Cloud</option>
                        <option>Power BI Varejo</option>
                    </select>
                </div>
                <div class="w-24">
                    <p class="text-[10px] font-bold text-gray-400 mb-1">Percentual</p>
                    <div class="flex items-center border border-gray-300 rounded overflow-hidden">
                        <input type="number" value="0" class="w-full text-center text-sm p-1 border-none focus:ring-0 font-bold text-blue-600">
                        <span class="bg-gray-100 text-xs px-2 py-1 text-gray-500 font-bold border-l border-gray-300">%</span>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-red-500 p-2" onclick="this.parentElement.remove()"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>`;
            lucide.createIcons();
        }

        function saveAllocations() {
            closeModal('allocation-modal');
            alert("Alocações atualizadas com sucesso!");
        }

        function openModal(id) {
            const m = document.getElementById(id);
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0'); m.querySelector('div').classList.remove('scale-95'); }, 10);
        }
        function closeModal(id) {
            const m = document.getElementById(id);
            m.classList.add('opacity-0');
            setTimeout(() => m.classList.add('hidden'), 300);
        }
        
        function setActiveLink(clicked) {
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('active');
                l.classList.add('inactive');
            });
            clicked.classList.add('active');
            clicked.classList.remove('inactive');
        }

        // Init
        renderContracts();
        renderTeam();
        renderScale();
        lucide.createIcons();
    </script>
</body>
</html>