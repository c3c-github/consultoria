<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline de Vendas - Metodologia 6MM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .card-shadow { box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s; }
        .card-shadow:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        /* Badge Colors */
        .badge-p { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .badge-m { background-color: #fce7f3; color: #9d174d; border: 1px solid #fbcfe8; }
        .badge-g { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

        .stage-column { min-width: 280px; max-width: 280px; }
        
        /* Navigation Active State */
        .nav-item.active { background-color: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .nav-item.inactive { color: #9ca3af; }
        .nav-item.inactive:hover { background-color: #1f2937; color: white; }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-gray-900 text-white flex flex-col hidden md:flex shadow-xl z-20">
        <div class="p-6 border-b border-gray-800">
            <h1 class="text-2xl font-bold tracking-tight text-blue-400">Sales<span class="text-white">Ops</span></h1>
            <p class="text-xs text-gray-400 mt-1">Metodologia 6MM</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="navigateTo('pipeline')" id="nav-pipeline" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition">
                <i class="fas fa-columns w-5"></i> Pipeline
            </button>
            <button onclick="navigateTo('reports')" id="nav-reports" class="nav-item inactive w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition">
                <i class="fas fa-chart-pie w-5"></i> Relatórios
            </button>
            <button onclick="navigateTo('settings')" id="nav-settings" class="nav-item inactive w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition">
                <i class="fas fa-cog w-5"></i> Configurações
            </button>
        </nav>
        <div class="p-4 border-t border-gray-800">
            <div class="bg-gray-800 rounded-lg p-3">
                <p class="text-xs text-gray-400">Meta Anual (<span id="sidebar-goal-label">6M</span>)</p>
                <div class="flex justify-between items-end mt-1">
                    <span class="font-bold text-lg" id="sidebar-achieved">R$ 0</span>
                    <span class="text-xs bg-green-900 text-green-300 px-1.5 py-0.5 rounded" id="goal-percentage">0%</span>
                </div>
                <div class="w-full bg-gray-700 h-1.5 rounded-full mt-2">
                    <div id="goal-progress-bar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content Wrapper -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-gray-50">
        
        <!-- Generic Header -->
        <header class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-6 z-10 shrink-0">
            <div class="flex items-center gap-4">
                <h2 class="text-xl font-semibold text-gray-800" id="page-title">Controle de Pipeline</h2>
                
                <!-- Period Selector (NEW) -->
                <div class="flex items-center gap-2 bg-gray-100 rounded-lg p-1 text-sm border border-gray-200 ml-4">
                    <span class="px-2 text-gray-500 font-medium"><i class="far fa-calendar-alt mr-1"></i> Período:</span>
                    <select id="period-filter" onchange="applyFilters()" class="bg-transparent border-none text-gray-700 font-semibold focus:ring-0 cursor-pointer outline-none">
                        <option value="all">Todo o Ano (2025)</option>
                        <option value="q1">1º Trimestre (Jan-Mar)</option>
                        <option value="q2" selected>2º Trimestre (Abr-Jun)</option>
                        <option value="q3">3º Trimestre (Jul-Set)</option>
                        <option value="q4">4º Trimestre (Out-Dez)</option>
                    </select>
                </div>
            </div>
            <!-- Action Button (Dynamic) -->
            <div id="header-actions">
                <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm flex items-center gap-2">
                    <i class="fas fa-plus"></i> Novo Deal
                </button>
            </div>
        </header>

        <!-- VIEW: PIPELINE (Default) -->
        <div id="view-pipeline" class="flex-1 flex flex-col overflow-hidden h-full">
            <!-- KPI Cards -->
            <div class="p-6 grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 border-b border-gray-200 shrink-0">
                <!-- Card 1 -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-medium text-gray-500 uppercase">Pipeline (Período)</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="total-pipeline">R$ 0</h3>
                        </div>
                        <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
                            <i class="fas fa-funnel-dollar"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Valor total no período selecionado</p>
                </div>

                <!-- Card 2: Mix -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm col-span-2">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-xs font-medium text-gray-500 uppercase">Mix de Projetos (Atual vs Meta)</p>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="bg-green-50 rounded-lg p-2 border border-green-100">
                            <p class="text-xs text-green-800 font-bold mb-1">G (><span class="label-g-val">1M</span>)</p>
                            <p class="text-sm font-bold text-gray-700"><span id="count-g">0</span> <span class="text-gray-400 text-xs font-normal">/ 2</span></p>
                        </div>
                        <div class="bg-pink-50 rounded-lg p-2 border border-pink-100">
                            <p class="text-xs text-pink-800 font-bold mb-1">M (<span class="label-m-val">1M</span>)</p>
                            <p class="text-sm font-bold text-gray-700"><span id="count-m">0</span> <span class="text-gray-400 text-xs font-normal">/ 4</span></p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-2 border border-blue-100">
                            <p class="text-xs text-blue-800 font-bold mb-1">P (<span class="label-p-val">500k</span>)</p>
                            <p class="text-sm font-bold text-gray-700"><span id="count-p">0</span> <span class="text-gray-400 text-xs font-normal">/ 6</span></p>
                        </div>
                    </div>
                </div>

                <!-- Card 3 -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm border-l-4 border-l-purple-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-medium text-gray-500 uppercase">Em Proposta</p>
                            <h3 class="text-2xl font-bold text-purple-600 mt-1" id="proposal-count">0</h3>
                        </div>
                        <div class="p-2 bg-purple-50 text-purple-600 rounded-lg">
                            <i class="fas fa-file-contract"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Necessário: <span class="font-bold">48/ano</span> (4/mês)</p>
                </div>
            </div>

            <!-- Kanban Board -->
            <div class="flex-1 overflow-x-auto overflow-y-hidden bg-gray-100 p-6 kanban-container custom-scrollbar">
                <div class="flex h-full gap-4" id="board-container">
                    <!-- Columns injected by JS -->
                </div>
            </div>
        </div>

        <!-- VIEW: RELATÓRIOS -->
        <div id="view-reports" class="hidden flex-1 p-8 overflow-y-auto custom-scrollbar">
            
            <!-- NEW: Comparativo Financeiro Trimestral -->
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm mb-6 overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">Comparativo Financeiro (Trimestral)</h3>
                    <select class="text-sm border-gray-300 rounded-md bg-gray-50 border p-1">
                        <option>Q2 2025 vs Q1 2025</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-gray-100">
                    <div class="p-6">
                        <p class="text-sm text-gray-500 mb-1">Volume Fechado (Trimestre Anterior)</p>
                        <p class="text-2xl font-bold text-gray-400">R$ 1.250.000</p>
                    </div>
                    <div class="p-6">
                        <p class="text-sm text-gray-500 mb-1">Volume Fechado (Trimestre Atual)</p>
                        <p class="text-2xl font-bold text-gray-800">R$ 1.650.000</p>
                    </div>
                    <div class="p-6 bg-green-50">
                        <p class="text-sm text-green-700 mb-1 font-medium">Crescimento</p>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-arrow-up text-green-600"></i>
                            <p class="text-2xl font-bold text-green-600">+32%</p>
                        </div>
                        <p class="text-xs text-green-600 mt-1">Acima da meta projetada</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- NEW: Timeline Chart -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm col-span-1 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Evolução do Pipeline (6 Meses)</h3>
                        <div class="flex gap-2 text-xs">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Proposta</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Fechado</span>
                        </div>
                    </div>
                    <div class="relative h-64 w-full">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>

                <!-- Chart 1: Funnel -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Gargalo do Funil (Atual)</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="funnelChart"></canvas>
                    </div>
                </div>

                <!-- Chart 2: Mix Distribution -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Distribuição do Mix (Valor R$)</h3>
                    <div class="relative h-64 w-full flex justify-center">
                        <canvas id="mixChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: CONFIGURAÇÕES -->
        <div id="view-settings" class="hidden flex-1 p-8 overflow-y-auto custom-scrollbar">
            <div class="max-w-2xl mx-auto space-y-6">
                
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Metas Globais</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Meta Anual de Vendas (R$)</label>
                            <input type="number" id="config-goal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="6000000">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Classificação de Projetos (Critérios)</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Limite Superior P (R$)</label>
                            <input type="number" id="config-limit-p" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="500000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Limite Superior M (R$)</label>
                            <input type="number" id="config-limit-m" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="1000000">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-4">
                    <button onclick="saveSettings()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition shadow-md flex items-center gap-2">
                        <i class="fas fa-save"></i> Salvar Alterações
                    </button>
                </div>

            </div>
        </div>

    </main>

    <!-- Modal Adicionar Deal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Novo Projeto</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="deal-form" onsubmit="handleAddDeal(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Cliente/Projeto</label>
                        <input type="text" id="deal-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="Ex: Migração Cloud XPTO">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Valor Estimado (R$)</label>
                        <input type="number" id="deal-value" required min="1000" step="1000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="0.00">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Etapa Inicial</label>
                        <select id="deal-stage" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                            <option value="qualificacao">1. Qualificação</option>
                            <option value="diagnostico">2. Diagnóstico</option>
                            <option value="validacao">3. Validação</option>
                            <option value="proposta">4. Proposta</option>
                            <option value="fechamento">5. Fechamento (Ganho)</option>
                        </select>
                    </div>

                    <div>
                         <label class="block text-sm font-medium text-gray-700 mb-1">Trimestre Previsto</label>
                         <select id="deal-qtr" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white">
                             <option value="q1">Q1</option>
                             <option value="q2" selected>Q2 (Atual)</option>
                             <option value="q3">Q3</option>
                             <option value="q4">Q4</option>
                         </select>
                    </div>
                </div>

                <div class="mt-8 flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition">Cancelar</button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition shadow-md">Salvar Deal</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Configuração Global ---
        let CONFIG = {
            annualGoal: 6000000,
            limitP: 500000,
            limitM: 1000000
        };

        const stages = [
            { id: 'qualificacao', name: '1. Qualificação', color: 'border-t-gray-400' },
            { id: 'diagnostico', name: '2. Diagnóstico', color: 'border-t-blue-400' },
            { id: 'validacao', name: '3. Validação', color: 'border-t-yellow-400' },
            { id: 'proposta', name: '4. Proposta (Zona Crítica)', color: 'border-t-purple-500' },
            { id: 'fechamento', name: '5. Fechamento', color: 'border-t-green-500' }
        ];

        // Estado inicial (Com dados de 'quarter' simulados para filtro)
        let deals = [
            { id: 1, name: 'Expansão Varejo Sul', value: 1200000, stage: 'proposta', quarter: 'q2', daysInStage: 12 },
            { id: 2, name: 'Consultoria Financeira', value: 300000, stage: 'diagnostico', quarter: 'q2', daysInStage: 45 },
            { id: 3, name: 'App Mobile Beta', value: 800000, stage: 'validacao', quarter: 'q2', daysInStage: 5 },
            { id: 4, name: 'Integração SAP', value: 450000, stage: 'qualificacao', quarter: 'q2', daysInStage: 2 },
            { id: 5, name: 'Banco de Dados Oracle', value: 200000, stage: 'fechamento', quarter: 'q1', daysInStage: 0 },
            { id: 6, name: 'Projeto Futuro Q3', value: 1500000, stage: 'qualificacao', quarter: 'q3', daysInStage: 0 }
        ];

        let funnelChartInstance = null;
        let mixChartInstance = null;
        let timelineChartInstance = null;
        
        // Filtro atual
        let currentFilter = 'q2';

        // --- Lógica de Negócio ---

        function getCategory(value) {
            if (value >= CONFIG.limitM) return 'G';
            if (value >= CONFIG.limitP) return 'M';
            return 'P';
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 }).format(value);
        }

        function formatShortCurrency(value) {
            if (value >= 1000000) return (value / 1000000) + 'M';
            if (value >= 1000) return (value / 1000) + 'k';
            return value;
        }

        function getBadgeClass(category) {
            if (category === 'G') return 'badge-g';
            if (category === 'M') return 'badge-m';
            return 'badge-p';
        }

        function applyFilters() {
            currentFilter = document.getElementById('period-filter').value;
            renderBoard();
        }

        function getFilteredDeals() {
            if (currentFilter === 'all') return deals;
            return deals.filter(d => d.quarter === currentFilter);
        }

        // --- Navegação ---

        function navigateTo(viewId) {
            // Update Menu
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active');
                el.classList.add('inactive');
            });
            document.getElementById(`nav-${viewId}`).classList.add('active');
            document.getElementById(`nav-${viewId}`).classList.remove('inactive');

            // Toggle Views
            document.getElementById('view-pipeline').classList.add('hidden');
            document.getElementById('view-reports').classList.add('hidden');
            document.getElementById('view-settings').classList.add('hidden');
            document.getElementById(`view-${viewId}`).classList.remove('hidden');

            // Header Controls
            const btnAction = document.getElementById('header-actions');
            const pageTitle = document.getElementById('page-title');
            const periodSelector = document.getElementById('period-filter').parentNode;

            if (viewId === 'pipeline') {
                pageTitle.innerText = "Controle de Pipeline";
                btnAction.classList.remove('hidden');
                periodSelector.classList.remove('hidden');
                renderBoard(); 
            } else if (viewId === 'reports') {
                pageTitle.innerText = "Relatórios de Performance";
                btnAction.classList.add('hidden');
                periodSelector.classList.add('hidden');
                renderCharts();
            } else {
                pageTitle.innerText = "Configurações do Sistema";
                btnAction.classList.add('hidden');
                periodSelector.classList.add('hidden');
            }
        }

        // --- Renderização do Pipeline ---

        function renderBoard() {
            const container = document.getElementById('board-container');
            container.innerHTML = '';
            
            const visibleDeals = getFilteredDeals();

            // Update Labels in Config UI
            document.querySelectorAll('.label-g-val').forEach(el => el.innerText = formatShortCurrency(CONFIG.limitM));
            document.querySelectorAll('.label-m-val').forEach(el => el.innerText = formatShortCurrency(CONFIG.limitM));
            document.querySelectorAll('.label-p-val').forEach(el => el.innerText = formatShortCurrency(CONFIG.limitP));

            stages.forEach(stage => {
                const stageDeals = visibleDeals.filter(d => d.stage === stage.id);
                const stageTotal = stageDeals.reduce((sum, d) => sum + d.value, 0);

                const column = document.createElement('div');
                column.className = `stage-column flex flex-col h-full bg-gray-200 rounded-xl`;
                
                column.innerHTML = `
                    <div class="p-3 border-t-4 ${stage.color} bg-gray-100 rounded-t-xl">
                        <h4 class="font-semibold text-gray-700 text-sm flex justify-between items-center">
                            ${stage.name}
                            <span class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full text-xs">${stageDeals.length}</span>
                        </h4>
                        <p class="text-xs text-gray-500 mt-1 font-medium text-right">${formatCurrency(stageTotal)}</p>
                    </div>
                    <div class="flex-1 p-2 overflow-y-auto space-y-3 custom-scrollbar" id="col-${stage.id}"></div>
                `;

                const cardsContainer = column.querySelector(`#col-${stage.id}`);

                stageDeals.forEach(deal => {
                    const category = getCategory(deal.value);
                    const alertClass = (deal.daysInStage > 30 && deal.stage !== 'fechamento') ? 'border-red-400 bg-red-50' : 'border-transparent bg-white';
                    const alertIcon = (deal.daysInStage > 30 && deal.stage !== 'fechamento') ? '<i class="fas fa-exclamation-circle text-red-500 text-xs ml-1" title="Alerta: Estagnado"></i>' : '';

                    const card = document.createElement('div');
                    card.className = `p-3 rounded-lg shadow-sm border-l-4 card-shadow relative group ${alertClass}`;
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs font-bold px-2 py-0.5 rounded ${getBadgeClass(category)}">Projeto ${category}</span>
                            ${alertIcon}
                        </div>
                        <h5 class="font-bold text-gray-800 text-sm leading-tight mb-1">${deal.name}</h5>
                        <p class="text-sm font-semibold text-gray-600 mb-3">${formatCurrency(deal.value)}</p>
                        
                        <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                            <span class="text-xs text-gray-400"><i class="far fa-clock"></i> ${deal.daysInStage}d na etapa</span>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                ${stage.id !== 'qualificacao' ? `<button onclick="moveDeal(${deal.id}, -1)" class="p-1 text-gray-400 hover:text-blue-600"><i class="fas fa-chevron-left"></i></button>` : ''}
                                ${stage.id !== 'fechamento' ? `<button onclick="moveDeal(${deal.id}, 1)" class="p-1 text-gray-400 hover:text-green-600"><i class="fas fa-chevron-right"></i></button>` : ''}
                                <button onclick="deleteDeal(${deal.id})" class="p-1 text-gray-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    `;
                    cardsContainer.appendChild(card);
                });

                container.appendChild(column);
            });

            updateGlobalStats(visibleDeals);
        }

        function updateGlobalStats(visibleDeals) {
            // Pipeline Value (Open deals only, filtered)
            const openDeals = visibleDeals.filter(d => d.stage !== 'fechamento');
            const totalValue = openDeals.reduce((sum, d) => sum + d.value, 0);
            document.getElementById('total-pipeline').innerText = formatCurrency(totalValue);

            // Won Value (All time for goal, or filtered?) Usually goal is annual
            // For the dashboard, we will show Annual achievement in Sidebar, but Filtered value in Cards
            const allWon = deals.filter(d => d.stage === 'fechamento').reduce((sum, d) => sum + d.value, 0);
            const progressPct = Math.min(100, Math.round((allWon / CONFIG.annualGoal) * 100));
            
            document.getElementById('sidebar-achieved').innerText = formatShortCurrency(allWon);
            document.getElementById('goal-percentage').innerText = progressPct + '%';
            document.getElementById('goal-progress-bar').style.width = progressPct + '%';
            document.getElementById('sidebar-goal-label').innerText = formatShortCurrency(CONFIG.annualGoal);

            // Counts (Filtered)
            let counts = { P: 0, M: 0, G: 0 };
            openDeals.forEach(d => counts[getCategory(d.value)]++);

            document.getElementById('count-g').innerText = counts.G;
            document.getElementById('count-m').innerText = counts.M;
            document.getElementById('count-p').innerText = counts.P;

            updateCountColor('count-g', counts.G, 2);
            updateCountColor('count-m', counts.M, 4);
            updateCountColor('count-p', counts.P, 6);

            const proposalCount = openDeals.filter(d => d.stage === 'proposta').length;
            document.getElementById('proposal-count').innerText = proposalCount;
        }

        function updateCountColor(elementId, current, target) {
            const el = document.getElementById(elementId);
            if(current >= target) el.className = "text-green-600";
            else el.className = "text-red-500";
        }

        // --- Charts ---

        function renderCharts() {
            // Destroy existing
            if(funnelChartInstance) funnelChartInstance.destroy();
            if(mixChartInstance) mixChartInstance.destroy();
            if(timelineChartInstance) timelineChartInstance.destroy();

            const allDeals = deals; // Reports typically use all data or have their own filters. Using ALL for now.

            // 1. Funnel Chart
            const stageCounts = stages.map(s => allDeals.filter(d => d.stage === s.id).length);
            const ctxFunnel = document.getElementById('funnelChart').getContext('2d');
            funnelChartInstance = new Chart(ctxFunnel, {
                type: 'bar',
                data: {
                    labels: stages.map(s => s.name.split('.')[1]),
                    datasets: [{
                        label: 'Oportunidades',
                        data: stageCounts,
                        backgroundColor: ['#9ca3af', '#60a5fa', '#facc15', '#a855f7', '#22c55e'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });

            // 2. Mix Chart
            let mixValue = { P: 0, M: 0, G: 0 };
            allDeals.forEach(d => mixValue[getCategory(d.value)] += d.value);
            const ctxMix = document.getElementById('mixChart').getContext('2d');
            mixChartInstance = new Chart(ctxMix, {
                type: 'doughnut',
                data: {
                    labels: ['Pequenos (P)', 'Médios (M)', 'Grandes (G)'],
                    datasets: [{
                        data: [mixValue.P, mixValue.M, mixValue.G],
                        backgroundColor: ['#3b82f6', '#ec4899', '#22c55e'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // 3. NEW: Timeline Evolution Chart (Simulated Data)
            const ctxTimeline = document.getElementById('timelineChart').getContext('2d');
            
            // Mock Data Generation for Timeline
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'];
            const pipelineData = [2500000, 3100000, 2800000, 4500000, 5200000, 6000000];
            const closedData = [100000, 300000, 500000, 1200000, 2000000, 2800000];

            timelineChartInstance = new Chart(ctxTimeline, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Valor em Proposta (Pipeline)',
                            data: pipelineData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Valor Fechado (Acumulado)',
                            data: closedData,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } }
                    }
                }
            });
        }

        // --- Configurações ---
        function saveSettings() {
            const newGoal = parseFloat(document.getElementById('config-goal').value);
            const newLimitP = parseFloat(document.getElementById('config-limit-p').value);
            const newLimitM = parseFloat(document.getElementById('config-limit-m').value);

            if(newGoal && newLimitP && newLimitM) {
                CONFIG.annualGoal = newGoal;
                CONFIG.limitP = newLimitP;
                CONFIG.limitM = newLimitM;
                alert('Configurações salvas!');
                navigateTo('pipeline');
            }
        }

        // --- Ações de Deal ---
        function moveDeal(id, direction) {
            const deal = deals.find(d => d.id === id);
            const currentStageIndex = stages.findIndex(s => s.id === deal.stage);
            const newIndex = currentStageIndex + direction;

            if (newIndex >= 0 && newIndex < stages.length) {
                deal.stage = stages[newIndex].id;
                deal.daysInStage = 0;
                renderBoard();
            }
        }

        function deleteDeal(id) {
            if(confirm('Tem certeza?')) {
                deals = deals.filter(d => d.id !== id);
                renderBoard();
            }
        }

        function handleAddDeal(e) {
            e.preventDefault();
            const name = document.getElementById('deal-name').value;
            const value = parseFloat(document.getElementById('deal-value').value);
            const stage = document.getElementById('deal-stage').value;
            const quarter = document.getElementById('deal-qtr').value;

            if (name && value) {
                deals.push({
                    id: Date.now(),
                    name: name,
                    value: value,
                    stage: stage,
                    quarter: quarter,
                    daysInStage: 0
                });
                closeModal();
                renderBoard(); // Will update based on current filter
                document.getElementById('deal-form').reset();
            }
        }

        const modal = document.getElementById('modal');
        function openModal() { modal.classList.remove('hidden'); }
        function closeModal() { modal.classList.add('hidden'); }
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        // Inicializar
        renderBoard();

    </script>
</body>
</html>