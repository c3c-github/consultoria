<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Desk - C3C Workplace</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- √çcones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonte Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        c3c: {
                            blue: '#2978FF',
                            teal: '#1DDDBD',
                            dark: '#1a1a1a',
                            bg: '#F8FAFC'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #F8FAFC; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
        
        /* Anima√ß√£o do Cron√¥metro */
        .timer-pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { text-shadow: 0 0 0 rgba(239, 68, 68, 0); }
            50% { text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
            100% { text-shadow: 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Scrollbar fina */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Abas Internas Ativas */
        .tab-active {
            border-bottom: 2px solid #2978FF;
            color: #2978FF;
            font-weight: 700;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #6B7280;
            font-weight: 500;
        }
        .tab-inactive:hover {
            color: #1a1a1a;
            border-bottom: 2px solid #E5E7EB;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-c3c-bg">

    <!-- 1. SIDEBAR -->
    <aside class="w-20 lg:w-64 bg-white border-r border-gray-100 flex flex-col z-20 transition-all duration-300">
        <div class="h-20 flex items-center justify-center lg:justify-start lg:px-8 border-b border-gray-50">
            <div class="w-8 h-8 bg-gradient-to-br from-[#2978FF] to-[#1DDDBD] rounded-lg flex items-center justify-center text-white font-bold text-xs">C3C</div>
            <span class="hidden lg:block ml-3 font-bold text-gray-800 tracking-wide text-lg">Workplace</span>
        </div>
        <nav class="flex-1 py-6 space-y-2">
            <a href="#" class="flex items-center justify-center lg:justify-start gap-3 px-4 lg:px-6 py-3 text-gray-400 hover:bg-gray-50 transition-colors">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="hidden lg:block font-medium text-sm">Vis√£o Geral</span>
            </a>
            <!-- Menu Ativo -->
            <a href="#" class="flex items-center justify-center lg:justify-start gap-3 px-4 lg:px-6 py-3 bg-indigo-50 text-indigo-600 border-r-4 border-indigo-500 font-semibold transition-colors">
                <i data-lucide="headset" class="w-5 h-5"></i>
                <span class="hidden lg:block text-sm">Mesa de Opera√ß√µes</span>
            </a>
        </nav>
        
        <!-- Widget Status -->
        <div class="p-4 border-t border-gray-100 bg-gray-50">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-bold text-gray-500 uppercase">Status</span>
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse" id="agent-status-led"></span>
            </div>
            <select id="agent-status-select" onchange="updateAgentStatus(this.value)" class="w-full text-xs border-gray-300 rounded p-1 bg-white text-gray-700 font-bold cursor-pointer">
                <option value="available">üü¢ Dispon√≠vel</option>
                <option value="busy">üî¥ Ocupado</option>
                <option value="break">‚òï Pausa</option>
            </select>
        </div>
    </aside>

    <!-- 2. MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative w-full overflow-hidden">
        
        <!-- Header Principal -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shrink-0 shadow-sm z-10">
            <div class="flex items-center gap-4">
                <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="layers" class="w-5 h-5 text-indigo-600"></i>
                    Opera√ß√£o N2
                </h1>
                
                <!-- Cron√¥metro Global -->
                <div class="hidden md:flex items-center bg-gray-100 rounded-full px-4 py-1.5 border border-gray-200 ml-4">
                    <div class="text-xl font-mono font-bold text-gray-600 mr-3 w-24 text-center" id="global-timer">00:00:00</div>
                    <div class="flex gap-1">
                        <button id="global-play" onclick="startGlobalTimer()" class="p-1.5 bg-green-500 hover:bg-green-600 text-white rounded-full transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled title="Selecione um chamado primeiro">
                            <i data-lucide="play" class="w-3 h-3 fill-current"></i>
                        </button>
                        <button id="global-pause" onclick="pauseGlobalTimer()" class="hidden p-1.5 bg-yellow-400 hover:bg-yellow-500 text-white rounded-full transition-transform active:scale-95">
                            <i data-lucide="pause" class="w-3 h-3 fill-current"></i>
                        </button>
                        <button id="global-stop" onclick="stopGlobalTimer()" class="hidden p-1.5 bg-red-500 hover:bg-red-600 text-white rounded-full transition-transform active:scale-95">
                            <i data-lucide="square" class="w-3 h-3 fill-current"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Total Hoje</p>
                    <p class="text-sm font-bold text-indigo-600" id="total-hours-today">0h 0m</p>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 flex overflow-hidden">
            
            <!-- LISTA DE CHAMADOS (Esquerda) -->
            <div class="w-[400px] flex flex-col border-r border-gray-200 bg-white">
                
                <!-- Abas da Lista -->
                <div class="flex border-b border-gray-200">
                    <button onclick="switchListTab('my')" id="list-tab-my" class="flex-1 py-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/50">
                        Meus (<span id="count-my">2</span>)
                    </button>
                    <button onclick="switchListTab('queue')" id="list-tab-queue" class="flex-1 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:bg-gray-50">
                        Fila (<span id="count-queue">2</span>)
                    </button>
                    <button onclick="switchListTab('team')" id="list-tab-team" class="flex-1 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:bg-gray-50">
                        Equipe (<span id="count-team">1</span>)
                    </button>
                </div>

                <!-- Lista: Meus Casos -->
                <div id="list-view-my" class="flex-1 overflow-y-auto p-3 space-y-2 bg-gray-50/30">
                    <!-- JS Populates -->
                </div>

                <!-- Lista: Fila Geral -->
                <div id="list-view-queue" class="hidden flex-1 overflow-y-auto p-3 space-y-2 bg-gray-50/30">
                    <!-- JS Populates -->
                </div>

                <!-- Lista: Equipe -->
                <div id="list-view-team" class="hidden flex-1 overflow-y-auto p-3 space-y-2 bg-gray-50/30">
                    <!-- JS Populates -->
                </div>
            </div>

            <!-- DETALHE DO CHAMADO (Direita) -->
            <div class="flex-1 bg-white flex flex-col relative" id="ticket-workspace">
                
                <!-- Estado Vazio -->
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 text-gray-400 z-0">
                    <i data-lucide="mouse-pointer-2" class="w-16 h-16 mb-4 text-gray-300"></i>
                    <p class="text-sm font-medium">Selecione um chamado para iniciar.</p>
                </div>

                <!-- Painel de Conte√∫do -->
                <div id="ticket-panel" class="flex-1 flex flex-col h-full hidden z-10 bg-white">
                    
                    <!-- Barra de Contexto (Avisos) -->
                    <div id="context-banner" class="hidden px-6 py-2 text-xs font-bold text-center border-b border-gray-100"></div>

                    <!-- Header do Chamado -->
                    <div class="px-6 py-4 border-b border-gray-200 bg-white flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-3 mb-1">
                                <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs font-mono font-bold" id="detail-id">#ID</span>
                                <span class="text-xs text-indigo-600 font-bold uppercase tracking-wider" id="detail-client">CLIENTE</span>
                                <span class="text-xs text-red-500 font-bold flex items-center gap-1" id="detail-sla-container"><i data-lucide="clock" class="w-3 h-3"></i> SLA: <span id="detail-sla"></span></span>
                            </div>
                            <h1 class="text-xl font-bold text-gray-900" id="detail-title">Titulo</h1>
                        </div>
                        
                        <!-- A√ß√µes R√°pidas (Din√¢mico) -->
                        <div class="flex gap-2" id="header-actions">
                            <!-- JS Injects Buttons -->
                        </div>
                    </div>

                    <!-- Navega√ß√£o Interna -->
                    <div class="px-6 pt-2 border-b border-gray-200 bg-gray-50/50 flex gap-6">
                        <button onclick="switchDetailTab('info')" id="dt-info" class="pb-3 text-sm tab-active">Informa√ß√µes</button>
                        <button onclick="switchDetailTab('logs')" id="dt-logs" class="pb-3 text-sm tab-inactive">Hist√≥rico & Tempos</button>
                        <button onclick="switchDetailTab('meta')" id="dt-meta" class="pb-3 text-sm tab-inactive">Metadados</button>
                    </div>

                    <!-- Conte√∫do das Abas -->
                    <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                        
                        <!-- ABA 1: INFO -->
                        <div id="view-info" class="space-y-6">
                            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Descri√ß√£o</h3>
                                <p class="text-sm text-gray-700 leading-relaxed" id="detail-desc">...</p>
                            </div>
                            <!-- Coment√°rios -->
                            <div>
                                <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Coment√°rios Recentes</h3>
                                <div id="comments-list" class="space-y-3"></div>
                                <div class="mt-3 flex gap-2 hidden" id="comment-box">
                                    <input type="text" id="quick-comment" placeholder="Adicionar anota√ß√£o..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <button onclick="postComment()" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700"><i data-lucide="send" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- ABA 2: LOGS DE TEMPO -->
                        <div id="view-logs" class="hidden h-full flex flex-col">
                            <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex-1">
                                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                    <h3 class="font-bold text-gray-800 text-sm">Apontamentos Realizados</h3>
                                    <span class="text-xs font-mono text-gray-500 bg-gray-200 px-2 py-1 rounded" id="ticket-total-time">Total: 0h 0m</span>
                                </div>
                                <div class="overflow-y-auto max-h-[400px]">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold sticky top-0">
                                            <tr>
                                                <th class="px-4 py-2">Data/Hora</th>
                                                <th class="px-4 py-2">Resumo</th>
                                                <th class="px-4 py-2">Tipo</th>
                                                <th class="px-4 py-2 text-right">Dura√ß√£o</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100" id="logs-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- ABA 3: METADADOS -->
                        <div id="view-meta" class="hidden">
                            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm grid grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Prioridade</label>
                                    <select class="w-full border border-gray-300 rounded p-2 text-sm"><option>Alta</option><option>M√©dia</option></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Status</label>
                                    <select class="w-full border border-gray-300 rounded p-2 text-sm" id="meta-status-select"><option value="open">Aberto</option><option value="progress">Em Andamento</option></select>
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Tags</label>
                                    <input type="text" class="w-full border border-gray-300 rounded p-2 text-sm" value="bug, login, critico">
                                </div>
                                <div class="col-span-2 text-right">
                                    <button onclick="alert('Salvo!')" class="text-xs font-bold text-indigo-600 hover:underline">Salvar Altera√ß√µes</button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL DE APONTAMENTO -->
    <div id="time-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-indigo-50 rounded-t-xl">
                <h3 class="font-bold text-indigo-900 flex items-center gap-2"><i data-lucide="clock" class="w-4 h-4"></i> Registrar Tempo</h3>
            </div>
            <div class="p-6">
                <div class="mb-4 bg-gray-50 p-2 rounded border border-gray-200">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Apontando em:</p>
                    <p class="text-sm font-bold text-gray-800 truncate" id="modal-ticket-name">#ID - Titulo</p>
                </div>
                <div class="mb-4">
                    <label class="block text-xs text-gray-500 font-bold mb-1">Dura√ß√£o</label>
                    <input type="text" id="modal-duration" class="w-full border border-gray-300 rounded p-2 text-lg text-center font-mono font-bold text-indigo-600 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Ex: 1h 30m">
                    <p class="text-[10px] text-gray-400 mt-1 text-center">Formatos: "01:30", "90", "1h 30m"</p>
                </div>
                <div class="mb-4">
                    <label class="block text-xs text-gray-500 font-bold mb-1">Descri√ß√£o do Trabalho</label>
                    <input type="text" id="modal-desc" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="O que foi feito?">
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal()" class="px-4 py-2 text-gray-500 font-bold text-xs hover:bg-gray-100 rounded">Cancelar</button>
                    <button onclick="saveLog()" class="px-4 py-2 bg-indigo-600 text-white font-bold text-xs rounded hover:bg-indigo-700 shadow-md">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-xl translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3 z-50">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
        <span class="text-sm font-bold" id="toast-msg">Opera√ß√£o realizada!</span>
    </div>

    <script>
        lucide.createIcons();

        // --- DADOS UNIFICADOS ---
        // list: 'my', 'queue', 'team'
        const tickets = {
            '1': { id: '#4505', title: 'Erro Cr√≠tico no Login', client: 'Tech Solutions', sla: '4h', desc: 'Usu√°rios n√£o conseguem logar no portal.', status: 'Em Andamento', list: 'my', logs: [], comments: [{user: 'N1', text: 'Escalado', time: '09:00'}] },
            '2': { id: '#4498', title: 'Relat√≥rio Vazio', client: 'Banco Alpha', sla: '2d', desc: 'Relat√≥rio mensal vindo em branco.', status: 'Pendente', list: 'my', logs: [], comments: [] },
            '4502': { id: '#4502', title: 'Erro 500 Checkout', client: 'Varejo Express', sla: 'Vencido', desc: 'Loja parada.', status: 'Aberto', list: 'queue', logs: [], comments: [] },
            '4510': { id: '#4510', title: 'Reset Senha AD', client: 'Tech Solutions', sla: '8h', desc: 'Bloqueado.', status: 'Aberto', list: 'queue', logs: [], comments: [] },
            '9001': { id: '#9001', title: 'Lentid√£o API', client: 'Banco Alpha', sla: '2h', desc: 'Lentid√£o.', status: 'Em Andamento', list: 'team', owner: 'Pedro Lima', logs: [], comments: [] }
        };

        let activeTicketId = null;
        let globalSeconds = 0;
        let globalInterval = null;
        let globalIsRunning = false;
        let runningOnTicketId = null; 

        // --- INICIALIZA√á√ÉO ---
        function renderLists() {
            renderList('my', 'list-view-my');
            renderList('queue', 'list-view-queue');
            renderList('team', 'list-view-team');
        }

        function renderList(type, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            Object.keys(tickets).forEach(key => {
                const t = tickets[key];
                if(t.list === type) {
                    let badgeColor = 'bg-gray-100 text-gray-600';
                    if(t.status === 'Em Andamento') badgeColor = 'bg-green-100 text-green-700';
                    if(t.status === 'Pendente') badgeColor = 'bg-yellow-100 text-yellow-700';
                    if(t.sla === 'Vencido') badgeColor = 'bg-red-100 text-red-700';

                    let extraInfo = t.client;
                    if(type === 'team') extraInfo = `${t.owner} ‚Ä¢ ${t.client}`;

                    container.innerHTML += `
                    <div onclick="selectTicket('${key}')" id="card-${key}" class="ticket-card cursor-pointer bg-white border border-gray-200 rounded-lg p-3 hover:shadow-md hover:border-indigo-300 transition-all mb-2">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs font-mono font-bold text-gray-600">${t.id}</span>
                            <span class="text-[10px] ${badgeColor} px-1.5 py-0.5 rounded font-bold">${t.status}</span>
                        </div>
                        <h4 class="font-bold text-gray-800 text-sm mb-1 line-clamp-1">${t.title}</h4>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span>${extraInfo}</span>
                            <div id="badge-time-${key}"></div>
                        </div>
                    </div>`;
                }
            });
        }

        // --- SELE√á√ÉO DE TICKET ---
        function selectTicket(id) {
            activeTicketId = id;
            const t = tickets[id];

            // Highlight
            document.querySelectorAll('.ticket-card').forEach(el => el.classList.remove('border-indigo-500', 'bg-indigo-50'));
            document.getElementById(`card-${id}`).classList.add('border-indigo-500', 'bg-indigo-50');

            // Show Panel
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('ticket-panel').classList.remove('hidden');

            // Fill Data
            document.getElementById('detail-id').innerText = t.id;
            document.getElementById('detail-client').innerText = t.client;
            document.getElementById('detail-title').innerText = t.title;
            document.getElementById('detail-desc').innerText = t.desc;
            document.getElementById('detail-sla').innerText = t.sla;

            // Context Logic
            setupContext(t);
            renderComments(id);
            renderLogs(id);
            switchDetailTab('info');
        }

        function setupContext(t) {
            const banner = document.getElementById('context-banner');
            const actions = document.getElementById('header-actions');
            const commentBox = document.getElementById('comment-box');
            const globalPlay = document.getElementById('global-play');

            // Default
            banner.className = "hidden";
            commentBox.classList.remove('hidden');
            globalPlay.disabled = false;
            globalPlay.title = "Iniciar";

            if (t.list === 'queue') {
                banner.className = "bg-yellow-100 text-yellow-800 px-6 py-2 text-xs font-bold text-center block";
                banner.innerText = "Modo Leitura: Este chamado est√° na fila.";
                commentBox.classList.add('hidden');
                globalPlay.disabled = true;
                actions.innerHTML = `<button onclick="pullTicket('${activeTicketId}')" class="flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white text-xs font-bold rounded-lg hover:bg-indigo-700 shadow-md"><i data-lucide="download" class="w-4 h-4"></i> Puxar Chamado</button>`;
            } 
            else if (t.list === 'team') {
                banner.className = "bg-blue-100 text-blue-800 px-6 py-2 text-xs font-bold text-center block";
                banner.innerText = `Em atendimento por ${t.owner}. Voc√™ est√° em modo de apoio.`;
                actions.innerHTML = `
                    <button onclick="openManualEntry()" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-300 text-gray-700 text-xs font-bold rounded-lg hover:bg-gray-50"><i data-lucide="edit-3" class="w-4 h-4"></i> Lan√ßar Apoio</button>
                    <button onclick="startContextTimer()" class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white text-xs font-bold rounded-lg hover:bg-green-700 shadow-md"><i data-lucide="play" class="w-4 h-4"></i> Cronometrar Apoio</button>
                `;
            } 
            else {
                // My Ticket
                actions.innerHTML = `
                    <button onclick="openManualEntry()" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-300 text-gray-700 text-xs font-bold rounded-lg hover:bg-gray-50"><i data-lucide="edit-3" class="w-4 h-4"></i> Lan√ßar Horas</button>
                    <button onclick="startContextTimer()" class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white text-xs font-bold rounded-lg hover:bg-green-700 shadow-md"><i data-lucide="play" class="w-4 h-4"></i> Iniciar Trabalho</button>
                `;
            }
            lucide.createIcons();
        }

        // --- A√á√ïES DE NEG√ìCIO ---
        function pullTicket(id) {
            if(confirm("Puxar este chamado para sua fila?")) {
                tickets[id].list = 'my';
                tickets[id].status = 'Em Andamento';
                renderLists();
                switchListTab('my');
                selectTicket(id);
                showToast("Chamado atribu√≠do a voc√™!");
            }
        }

        function switchListTab(tab) {
            ['my', 'queue', 'team'].forEach(t => {
                document.getElementById(`list-tab-${t}`).className = `flex-1 py-3 text-sm font-bold border-b-2 transition-colors ${tab === t ? 'text-indigo-600 border-indigo-600 bg-indigo-50/50' : 'text-gray-500 border-transparent hover:bg-gray-50'}`;
                document.getElementById(`list-view-${t}`).classList.toggle('hidden', tab !== t);
            });
        }

        // --- CRON√îMETRO ---
        function startGlobalTimer() {
            if(!activeTicketId) return alert("Selecione um chamado.");
            if(globalIsRunning) return;
            
            runningOnTicketId = activeTicketId;
            globalIsRunning = true;
            document.getElementById('global-play').classList.add('hidden');
            document.getElementById('global-pause').classList.remove('hidden');
            document.getElementById('global-stop').classList.remove('hidden');
            document.getElementById('global-timer').classList.add('text-red-600', 'timer-pulse');
            
            globalInterval = setInterval(() => {
                globalSeconds++;
                const h = Math.floor(globalSeconds / 3600).toString().padStart(2,'0');
                const m = Math.floor((globalSeconds % 3600) / 60).toString().padStart(2,'0');
                const s = (globalSeconds % 60).toString().padStart(2,'0');
                document.getElementById('global-timer').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        function pauseGlobalTimer() {
            globalIsRunning = false;
            clearInterval(globalInterval);
            document.getElementById('global-play').classList.remove('hidden');
            document.getElementById('global-pause').classList.add('hidden');
            document.getElementById('global-timer').classList.remove('timer-pulse');
        }

        function stopGlobalTimer() {
            pauseGlobalTimer();
            openLogModal(true);
        }

        function startContextTimer() { startGlobalTimer(); }

        // --- APONTAMENTO ---
        function openManualEntry() { openLogModal(false); }

        function openLogModal(fromTimer) {
            const t = tickets[activeTicketId];
            document.getElementById('modal-ticket-name').innerText = `${t.id} - ${t.title}`;
            
            if(fromTimer) {
                const h = Math.floor(globalSeconds / 3600).toString().padStart(2,'0');
                const m = Math.floor((globalSeconds % 3600) / 60).toString().padStart(2,'0');
                document.getElementById('modal-duration').value = `${h}:${m}`;
                document.getElementById('modal-duration').readOnly = false; 
            } else {
                document.getElementById('modal-duration').value = '';
                document.getElementById('modal-duration').placeholder = 'Ex: 30m, 1h';
            }
            
            document.getElementById('time-modal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('time-modal').classList.remove('opacity-0');
                document.querySelector('#time-modal > div').classList.remove('scale-95');
            }, 10);
        }

        function saveLog() {
            const durationStr = document.getElementById('modal-duration').value;
            const desc = document.getElementById('modal-desc').value || "Atendimento";
            let minutes = 0;

            // Parser simples
            if(durationStr.includes(':')) {
                const p = durationStr.split(':');
                minutes = (+p[0]*60) + (+p[1]);
            } else if(durationStr.includes('h') || durationStr.includes('m')) {
                // Mock parse for "1h 30m"
                minutes = 90; 
            } else {
                minutes = parseInt(durationStr) || 0;
            }

            if(minutes <= 0) { alert("Tempo inv√°lido"); return; }

            tickets[activeTicketId].logs.push({
                date: new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}),
                desc: desc,
                type: 'T√©cnico',
                minutes: minutes
            });

            // Se veio do timer, resetar
            if(globalSeconds > 0 && !globalIsRunning) {
                globalSeconds = 0;
                document.getElementById('global-timer').innerText = "00:00:00";
                document.getElementById('global-stop').classList.add('hidden');
            }

            renderLogs(activeTicketId);
            closeModal();
            showToast("Apontamento Salvo!");
        }

        function closeModal() {
            document.getElementById('time-modal').classList.add('opacity-0');
            setTimeout(() => document.getElementById('time-modal').classList.add('hidden'), 300);
        }

        function renderLogs(id) {
            const t = tickets[id];
            const tbody = document.getElementById('logs-table-body');
            tbody.innerHTML = '';
            let total = 0;
            
            t.logs.forEach(l => {
                total += l.minutes;
                const h = Math.floor(l.minutes/60);
                const m = l.minutes%60;
                tbody.innerHTML += `
                <tr class="border-b border-gray-50 last:border-0">
                    <td class="px-4 py-2 text-xs text-gray-500">${l.date}</td>
                    <td class="px-4 py-2 text-sm text-gray-800">${l.desc}</td>
                    <td class="px-4 py-2 text-xs text-gray-500">${l.type}</td>
                    <td class="px-4 py-2 text-right font-mono text-xs font-bold text-indigo-600">${h}h ${m}m</td>
                </tr>`;
            });
            
            const th = Math.floor(total/60);
            const tm = total%60;
            document.getElementById('ticket-total-time').innerText = `Total: ${th}h ${tm}m`;
            
            // Badge na lista
            const badge = document.getElementById(`badge-time-${id}`);
            if(badge && total > 0) badge.innerHTML = `<i data-lucide="clock" class="w-3 h-3 text-indigo-500"></i> ${th}h ${tm}m`;
            lucide.createIcons();
        }

        // --- EXTRAS ---
        function switchDetailTab(tab) {
            ['info', 'logs', 'meta'].forEach(t => {
                const btn = document.getElementById(`dt-${t}`);
                const view = document.getElementById(`view-${t}`);
                if(t === tab) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive');
                    view.classList.remove('hidden');
                } else {
                    btn.classList.remove('tab-active');
                    btn.classList.add('tab-inactive');
                    view.classList.add('hidden');
                }
            });
        }

        function renderComments(id) {
            const list = document.getElementById('comments-list');
            list.innerHTML = '';
            tickets[id].comments.forEach(c => {
                list.innerHTML += `<div class="bg-gray-50 p-2 rounded text-xs border border-gray-100"><span class="font-bold text-gray-700">${c.user}:</span> ${c.text} <span class="block text-[9px] text-gray-400 mt-1">${c.time}</span></div>`;
            });
        }

        function postComment() {
            const txt = document.getElementById('quick-comment').value;
            if(!txt) return;
            tickets[activeTicketId].comments.unshift({user:'Eu', text: txt, time: 'Agora'});
            renderComments(activeTicketId);
            document.getElementById('quick-comment').value = '';
        }

        function showToast(msg) {
            document.getElementById('toast-msg').innerText = msg;
            const t = document.getElementById('toast');
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // Init
        renderLists();
    </script>
</body>
</html>