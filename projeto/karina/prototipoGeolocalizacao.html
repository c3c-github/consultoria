<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karina Plásticos | Intelligence Geoespacial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8e0;
            overflow: hidden;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
        }

        #map {
            height: calc(100vh - 80px);
            width: 100%;
            z-index: 1;
            border-radius: 16px;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .active-item {
            border-left: 4px solid #3b82f6;
            background: rgba(59, 130, 246, 0.15) !important;
        }
        
        .leaflet-container {
            background: #0f172a !important;
        }

        .timeline-card {
            min-width: 180px;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        
        .timeline-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header -->
    <header class="h-16 flex items-center justify-between px-6 glass-card mx-4 mt-2 mb-2 z-10">
        <div class="flex items-center gap-4">
            <!-- Branding Karina Plásticos Atualizado -->
            <div class="bg-white/95 rounded-lg px-3 py-1.5 shadow-lg shadow-blue-500/10 hover:shadow-blue-500/20 transition-all cursor-pointer">
                <img src="https://www.karina.com.br/wp-content/themes/karina2022/assets/images/logo.svg" alt="Karina Plásticos" class="h-8 w-auto">
            </div>
            
            <div class="hidden sm:block border-l border-slate-600 pl-4 h-8 flex items-center">
                <p class="text-[10px] text-slate-400 uppercase tracking-[0.2em] font-medium">Geo-Intelligence Hub</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-slate-800/40 border border-slate-700/50 rounded-lg px-3 py-1.5">
                <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i>
                <input type="date" value="2026-02-03" class="bg-transparent text-xs outline-none text-white cursor-pointer font-medium">
            </div>

            <div class="flex bg-slate-800/60 p-1 rounded-lg border border-slate-700/50 shadow-inner">
                <button id="view-team" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-blue-600 text-white shadow-lg">MINHA EQUIPE</button>
                <button id="view-board" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all text-slate-400 hover:text-white">DIRETORIA</button>
            </div>

            <div class="flex items-center gap-3 ml-2 pl-4 border-l border-slate-700/50">
                <div class="text-right hidden lg:block">
                    <p class="text-xs font-bold text-white">Ricardo Souza</p>
                    <p class="text-[10px] text-slate-500 font-medium">Supervisor de Campo</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-slate-700 border border-slate-600 flex items-center justify-center overflow-hidden shadow-md">
                    <i data-lucide="user" class="w-5 h-5 text-slate-300"></i>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 flex px-4 pb-4 gap-4 overflow-hidden">
        
        <!-- Sidebar Esquerda -->
        <aside class="w-80 flex flex-col gap-4">
            <div class="glass-card p-5 transition-all duration-300">
                <div class="flex justify-between items-start mb-4">
                    <h3 id="kpi-title" class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Performance Global</h3>
                    <span id="kpi-badge" class="text-green-400 text-[10px] flex items-center gap-1 font-bold bg-green-500/10 px-2 py-0.5 rounded border border-green-500/20 transition-all">
                        +12.4%
                    </span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p id="kpi-sales" class="text-xl font-black text-white transition-all">R$ 42.8k</p>
                        <p class="text-[9px] text-slate-500 uppercase font-bold mt-1">Volume Vendas</p>
                    </div>
                    <div>
                        <p id="kpi-adherence" class="text-xl font-black text-white transition-all">88%</p>
                        <p class="text-[9px] text-slate-500 uppercase font-bold mt-1">Aderência Rota</p>
                    </div>
                </div>
            </div>

            <div class="glass-card flex-1 flex flex-col overflow-hidden">
                <div class="p-4 border-b border-slate-700/50 bg-slate-800/20 flex justify-between items-center">
                    <h3 class="font-bold text-xs flex items-center gap-2 tracking-wide">
                        <i data-lucide="users" class="w-4 h-4 text-blue-500"></i>
                        VENDEDORES
                    </h3>
                    <span id="team-count" class="text-[9px] bg-slate-700 text-slate-300 px-2 py-0.5 rounded-full font-bold">3 ATIVOS</span>
                </div>
                <!-- Container da Lista -->
                <div class="flex-1 overflow-y-auto p-2 space-y-1">
                    <!-- Botão TODOS fixo no topo -->
                    <div id="btn-all-sellers" onclick="selectAllSellers(this)" class="p-3 rounded-lg cursor-pointer hover:bg-slate-700/40 transition-all border border-transparent flex justify-between items-center group mb-2 bg-slate-800/40 active-item">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-600/20 flex items-center justify-center border border-blue-500/30">
                                <i data-lucide="layers" class="w-4 h-4 text-blue-400"></i>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-white group-hover:text-blue-400 transition-colors">Todos os Vendedores</p>
                                <p class="text-[9px] text-slate-500 font-bold uppercase">Visão Agregada</p>
                            </div>
                        </div>
                    </div>
                    <!-- Lista dinâmica de vendedores -->
                    <div id="seller-list" class="space-y-1"></div>
                </div>
            </div>

            <div class="glass-card p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Atividade / Hora</h3>
                    <i data-lucide="activity" class="w-3 h-3 text-blue-500"></i>
                </div>
                <div class="relative h-28">
                    <canvas id="miniChart"></canvas>
                </div>
            </div>
        </aside>

        <!-- Área Central -->
        <section class="flex-1 flex flex-col relative">
            <div id="map"></div>
            
            <div class="absolute top-4 right-4 z-[1000] flex flex-col gap-2">
                <button id="toggle-heatmap" class="glass-card px-4 py-2.5 flex items-center gap-3 hover:bg-slate-700 transition-all shadow-xl group border border-slate-600/50">
                    <i data-lucide="flame" class="w-4 h-4 text-orange-500 group-hover:scale-110 transition-transform"></i>
                    <span class="text-xs font-bold text-white uppercase tracking-tighter">Histórico (Calor)</span>
                </button>
                <button id="toggle-routes" class="glass-card px-4 py-2.5 flex items-center gap-3 hover:bg-slate-700 transition-all shadow-xl group border border-slate-600/50">
                    <i data-lucide="navigation" class="w-4 h-4 text-blue-400 group-hover:scale-110 transition-transform"></i>
                    <span class="text-xs font-bold text-white uppercase tracking-tighter">Rotas Planejadas</span>
                </button>
            </div>

            <!-- Timeline de Visitas com Scroll Horizontal -->
            <div id="timeline-container" class="absolute bottom-4 left-4 right-4 z-[1000] glass-card p-4 h-44 flex flex-col shadow-2xl border-blue-500/20 transition-all duration-300">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <i data-lucide="map-pin" class="w-4 h-4 text-blue-500"></i>
                        <span id="selected-seller-name" class="font-black text-sm tracking-tight text-white uppercase">Vendedor: Todos</span>
                        <span id="seller-status-badge" class="bg-blue-500/10 text-blue-400 text-[8px] px-2 py-1 rounded-md font-black uppercase border border-blue-500/20">Visão Geral</span>
                    </div>
                    <div class="flex gap-4 text-[9px] font-black text-slate-500 tracking-tighter">
                        <span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-green-500"></span> CONCLUÍDA</span>
                        <span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span> EM VISITA</span>
                        <span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-slate-600"></span> PLANEJADA</span>
                    </div>
                </div>
                <!-- Container de Scroll Horizontal -->
                <div id="visit-timeline" class="flex gap-4 overflow-x-auto pb-4 h-full items-center px-1">
                    <!-- Cards de visita extensos aqui -->
                </div>
            </div>
        </section>

        <!-- Sidebar Direita -->
        <aside class="w-72 flex flex-col gap-4">
            <div class="glass-card p-4 flex-1">
                <h3 class="font-bold text-xs mb-4 flex items-center gap-2 border-b border-slate-700/50 pb-2 text-white tracking-widest uppercase">
                    <i data-lucide="zap" class="w-3.5 h-3.5 text-yellow-500"></i>
                    Insights de Campo
                </h3>
                <div class="space-y-3">
                    <div class="p-3 bg-red-500/5 border-l-2 border-red-500 rounded-r-lg">
                        <p class="text-[9px] font-black text-red-400 uppercase mb-1">Atraso Crítico</p>
                        <p class="text-[11px] text-slate-300 leading-tight">Vendedor está a 30min de atraso em Plásticos ABC.</p>
                    </div>
                    <div class="p-3 bg-blue-500/5 border-l-2 border-blue-500 rounded-r-lg">
                        <p class="text-[9px] font-black text-blue-400 uppercase mb-1">Otimização</p>
                        <p class="text-[11px] text-slate-300 leading-tight">Cliente "Ind. Global" detectado a 1.2km de Julia Costa.</p>
                    </div>
                </div>
            </div>

            <!-- Produtividade Semanal Re-implementada -->
            <div class="glass-card p-4 h-64">
                <div class="mb-3">
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Produtividade Semanal</h3>
                    <p class="text-[9px] text-slate-500 font-medium italic mt-0.5">Total de visitas / Últimos 5 dias</p>
                </div>
                <div class="relative h-40">
                    <canvas id="weeklyProdChart"></canvas>
                </div>
            </div>
        </aside>

    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
        lucide.createIcons();

        let visitsChartInstance = null;
        let weeklyProdChartInstance = null;
        let heatmapLayer = null;
        let routeLayer = null; 
        let showHeatmap = false;
        let showRoutes = false; 
        let currentSelectedSeller = null; // null significa "Todos"

        const clientCoords = {
            "Plásticos ABC": [-23.5555, -46.6350],
            "Ind. Polímeros": [-23.5480, -46.6320],
            "Recicla Plus": [-23.5600, -46.6400],
            "Master Batches": [-23.5700, -46.6500],
            "Ind. TuboFlex": [-23.5750, -46.6550],
            "Resinas Sul": [-23.5850, -46.6600],
            "Global Polymers": [-23.5900, -46.6700],
            "Química Verde": [-23.6000, -46.6800],
            "Logística Alpha": [-23.6100, -46.6900],
            "Distrib. Sul": [-23.6200, -46.7000],
            "TechPolymer": [-23.5850, -46.6650],
            "Auto Partes": [-23.5950, -46.6750],
            "Agro Tubos": [-23.4450, -46.5250]
        };

        // Adicionamos dados de vendas (sales) e aderência (adherence) ao modelo
        const teams = {
            "Regional SP Capital": [
                { 
                    id: 1, name: "Marcos Silva", status: "Em Visita", lat: -23.5505, lng: -46.6333, color: "#3b82f6", 
                    kpis: { sales: 18200, adherence: 92, growth: 15.5 },
                    performance: { hourly: [4, 18, 12, 22, 10, 5], weekly: [18, 24, 21, 28, 15] },
                    visits: [
                        { id: 101, client: "Plásticos ABC", time: "08:00", status: "done" },
                        { id: 102, client: "Ind. Polímeros", time: "09:30", status: "done" },
                        { id: 103, client: "Recicla Plus", time: "11:00", status: "current" },
                        { id: 104, client: "Master Batches", time: "13:00", status: "pending" },
                        { id: 105, client: "Ind. TuboFlex", time: "14:15", status: "pending" },
                        { id: 106, client: "Resinas Sul", time: "15:30", status: "pending" },
                        { id: 107, client: "Global Polymers", time: "16:45", status: "pending" },
                        { id: 108, client: "Química Verde", time: "18:00", status: "pending" }
                    ]
                },
                { 
                    id: 2, name: "Julia Costa", status: "Deslocamento", lat: -23.5900, lng: -46.6700, color: "#10b981", 
                    kpis: { sales: 14500, adherence: 85, growth: 8.2 },
                    performance: { hourly: [2, 10, 15, 12, 8, 4], weekly: [12, 18, 15, 20, 12] },
                    visits: [
                        { id: 201, client: "TechPolymer", time: "08:30", status: "done" },
                        { id: 202, client: "Auto Partes", time: "11:00", status: "current" }
                    ]
                }
            ],
            "Regional Interior": [
                { 
                    id: 3, name: "Roberto Dias", status: "Check-out", lat: -23.4500, lng: -46.5300, color: "#f59e0b", 
                    kpis: { sales: 10100, adherence: 96, growth: 5.1 },
                    performance: { hourly: [5, 8, 10, 8, 5, 2], weekly: [10, 12, 14, 10, 8] },
                    visits: [
                        { id: 301, client: "Agro Tubos", time: "09:00", status: "done" }
                    ]
                }
            ]
        };

        const allSellers = Object.values(teams).flat();
        
        const map = L.map('map', { zoomControl: false }).setView([-23.5505, -46.6333], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'Karina Plásticos' }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        const heatPoints = [
            [-23.5505, -46.6333, 1], [-23.551, -46.634, 0.9], [-23.549, -46.632, 0.9],
            [-23.553, -46.638, 0.8], [-23.560, -46.645, 0.7], [-23.59, -46.67, 1],
            [-23.595, -46.675, 0.8], [-23.600, -46.680, 0.6], [-23.45, -46.53, 1],
            [-23.455, -46.535, 0.8], [-23.460, -46.540, 0.7], [-23.550, -46.630, 0.9]
        ];

        function initApp() {
            renderSellerList('team');
            renderMapElements();
            
            // Inicializar com TODOS selecionados
            selectAllSellers(document.getElementById('btn-all-sellers'));
        }

        // Função para calcular dados agregados
        function calculateAggregateData() {
            const hourly = [0, 0, 0, 0, 0, 0];
            const weekly = [0, 0, 0, 0, 0];
            let totalSales = 0;
            let totalAdh = 0;
            let totalGrowth = 0;
            
            allSellers.forEach(seller => {
                seller.performance.hourly.forEach((val, idx) => hourly[idx] += val);
                seller.performance.weekly.forEach((val, idx) => weekly[idx] += val);
                totalSales += seller.kpis.sales;
                totalAdh += seller.kpis.adherence;
                totalGrowth += seller.kpis.growth;
            });

            // Médias para porcentagens
            const avgAdh = Math.round(totalAdh / allSellers.length);
            const avgGrowth = (totalGrowth / allSellers.length).toFixed(1);

            return { hourly, weekly, totalSales, avgAdh, avgGrowth };
        }

        // Função auxiliar para formatar moeda
        function formatCurrency(value) {
            return (value / 1000).toFixed(1) + 'k';
        }

        function renderSellerList(view) {
            const list = document.getElementById('seller-list');
            list.innerHTML = '';
            
            if (view === 'team') {
                teams["Regional SP Capital"].forEach(s => createSellerItem(s, list));
                document.getElementById('team-count').innerText = `${teams["Regional SP Capital"].length} ATIVOS`;
            } else {
                for (const teamName in teams) {
                    const h = document.createElement('div');
                    h.className = "text-[9px] font-black text-slate-500 uppercase tracking-widest px-2 py-3 mt-1 border-t border-slate-700/30";
                    h.innerText = teamName;
                    list.appendChild(h);
                    teams[teamName].forEach(s => createSellerItem(s, list));
                }
                document.getElementById('team-count').innerText = `${allSellers.length} ATIVOS`;
            }
        }

        function createSellerItem(seller, container) {
            const item = document.createElement('div');
            item.className = "seller-item p-3 rounded-lg cursor-pointer hover:bg-slate-700/40 transition-all border border-transparent flex justify-between items-center group mb-1";
            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-1 h-6 rounded-full" style="background-color: ${seller.color}"></div>
                    <div>
                        <p class="text-xs font-bold text-white group-hover:text-blue-400 transition-colors">${seller.name}</p>
                        <p class="text-[9px] text-slate-500 font-bold uppercase">${seller.status}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[9px] font-bold text-slate-400">R$ ${formatCurrency(seller.kpis.sales)}</p>
                </div>
            `;
            item.onclick = () => selectSeller(seller, item);
            container.appendChild(item);
            lucide.createIcons();
        }

        function renderMapElements() {
            // Plotar Clientes (Verdes)
            for (const [name, coords] of Object.entries(clientCoords)) {
                L.circleMarker(coords, {
                    radius: 5, fillColor: "#10b981", color: "#fff", weight: 1.5, opacity: 1, fillOpacity: 0.8
                }).addTo(map).bindPopup(`<b>Cliente:</b> ${name}`);
            }

            // Plotar Vendedores
            allSellers.forEach(s => {
                L.circleMarker([s.lat, s.lng], {
                    radius: 7, fillColor: s.color, color: "#fff", weight: 2, opacity: 1, fillOpacity: 1
                }).addTo(map).bindPopup(`<b>${s.name}</b><br>${s.status}`);
            });
        }

        // Função para selecionar TODOS
        function selectAllSellers(el) {
            currentSelectedSeller = null; // null = todos
            
            // UI Update
            document.querySelectorAll('.active-item').forEach(i => i.classList.remove('active-item'));
            document.querySelectorAll('.seller-item').forEach(i => i.classList.remove('active-item'));
            if(el) el.classList.add('active-item');

            const aggData = calculateAggregateData();

            // Atualizar Textos e KPIs Dinamicamente
            document.getElementById('selected-seller-name').innerText = `Vendedor: Todos`;
            document.getElementById('seller-status-badge').innerText = `Visão Geral`;
            
            // KPI Update
            document.getElementById('kpi-title').innerText = "Performance Global";
            document.getElementById('kpi-sales').innerText = `R$ ${formatCurrency(aggData.totalSales)}`;
            document.getElementById('kpi-adherence').innerText = `${aggData.avgAdh}%`;
            document.getElementById('kpi-badge').innerHTML = `+${aggData.avgGrowth}%`;
            document.getElementById('kpi-badge').className = "text-green-400 text-[10px] flex items-center gap-1 font-bold bg-green-500/10 px-2 py-0.5 rounded border border-green-500/20 transition-all";

            // Mapa - Fit Bounds em todos os vendedores
            const group = new L.featureGroup(allSellers.map(s => L.marker([s.lat, s.lng])));
            map.fitBounds(group.getBounds().pad(0.2));

            // Charts Agregados
            renderFrequencyChart(aggData.hourly);
            renderWeeklyProdChart(aggData.weekly);

            // Timeline Agregada (Mostra mensagem ou resumo)
            const timelineContainer = document.getElementById('visit-timeline');
            timelineContainer.innerHTML = `
                <div class="flex items-center justify-center w-full h-full text-slate-500 text-xs italic">
                    Selecione um vendedor específico para ver a linha do tempo detalhada.
                </div>
            `;
            
            // Remover rota se estiver ativa
            if (routeLayer) map.removeLayer(routeLayer);
        }

        function selectSeller(seller, el) {
            currentSelectedSeller = seller;
            
            // UI Update
            document.getElementById('btn-all-sellers').classList.remove('active-item');
            document.querySelectorAll('.seller-item').forEach(i => i.classList.remove('active-item'));
            if (el) el.classList.add('active-item');

            // Atualizar textos e KPIs Individuais
            document.getElementById('selected-seller-name').innerText = `Vendedor: ${seller.name}`;
            document.getElementById('seller-status-badge').innerText = seller.status;
            
            // KPI Update
            document.getElementById('kpi-title').innerText = "Performance Individual";
            document.getElementById('kpi-sales').innerText = `R$ ${formatCurrency(seller.kpis.sales)}`;
            document.getElementById('kpi-adherence').innerText = `${seller.kpis.adherence}%`;
            document.getElementById('kpi-badge').innerHTML = `+${seller.kpis.growth}%`;
            
            // Muda cor do badge baseado no valor
            const badgeClass = seller.kpis.growth >= 10 
                ? "text-green-400 bg-green-500/10 border-green-500/20" 
                : "text-yellow-400 bg-yellow-500/10 border-yellow-500/20";
            document.getElementById('kpi-badge').className = `${badgeClass} text-[10px] flex items-center gap-1 font-bold px-2 py-0.5 rounded border transition-all`;

            map.flyTo([seller.lat, seller.lng], 14);
            renderTimeline(seller);
            
            // Charts Individuais
            renderFrequencyChart(seller.performance.hourly);
            renderWeeklyProdChart(seller.performance.weekly);

            if (showRoutes) {
                drawRoute(seller);
            }
        }

        function renderTimeline(seller) {
            const container = document.getElementById('visit-timeline');
            container.innerHTML = '';
            seller.visits.forEach(v => {
                const colors = { 'done': 'bg-green-500', 'current': 'bg-blue-500', 'pending': 'bg-slate-700' };
                const labels = { 'done': 'CONCLUÍDA', 'current': 'EM VISITA', 'pending': 'PLANEJADA' };
                
                const card = document.createElement('div');
                card.className = "timeline-card p-4 rounded-xl glass-card flex flex-col justify-between h-28 border-slate-700/50 cursor-pointer hover:bg-slate-700/60 hover:border-blue-500/50 transition-all";
                
                card.onclick = () => {
                    if (clientCoords[v.client]) {
                        map.flyTo(clientCoords[v.client], 16, {
                            animate: true,
                            duration: 1.5
                        });
                    }
                };

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <p class="text-[9px] text-slate-500 font-black tracking-tighter">${v.time}</p>
                            <i data-lucide="map-pin" class="w-3 h-3 text-slate-600 hover:text-blue-400 transition-colors"></i>
                        </div>
                        <p class="text-xs font-bold text-white truncate w-full">${v.client}</p>
                    </div>
                    <div class="flex items-center gap-2 mt-3">
                        <div class="h-1 flex-1 rounded-full ${colors[v.status]}"></div>
                        <span class="text-[7px] font-black text-slate-500 whitespace-nowrap">${labels[v.status]}</span>
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function renderFrequencyChart(data) {
            const ctx = document.getElementById('miniChart').getContext('2d');
            if(visitsChartInstance) visitsChartInstance.destroy();
            visitsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['08h', '10h', '12h', '14h', '16h', '18h'],
                    datasets: [{
                        data: data || [0,0,0,0,0,0],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.05)',
                        fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    animation: { duration: 600 },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#475569', font: { size: 8 } } },
                        y: { suggestedMax: Math.max(...(data || [10])) + 5, display: false }
                    }
                }
            });
        }

        function renderWeeklyProdChart(data) {
            const ctx = document.getElementById('weeklyProdChart').getContext('2d');
            if(weeklyProdChartInstance) weeklyProdChartInstance.destroy();
            weeklyProdChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['27/01', '28/01', '29/01', '30/01', 'Hoje'],
                    datasets: [{
                        label: 'Visitas',
                        data: data || [0,0,0,0,0],
                        backgroundColor: (c) => c.index === 4 ? '#3b82f6' : 'rgba(59, 130, 246, 0.3)',
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    animation: { duration: 600 },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 9, weight: 'bold' } } },
                        y: { 
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#475569', font: { size: 8 } }
                        }
                    }
                }
            });
        }

        function drawRoute(seller) {
            if (routeLayer) map.removeLayer(routeLayer);
            
            const path = [[seller.lat, seller.lng]]; 
            seller.visits.forEach(v => {
                if (clientCoords[v.client]) {
                    path.push(clientCoords[v.client]);
                }
            });

            routeLayer = L.polyline(path, {
                color: seller.color,
                weight: 3,
                opacity: 0.6,
                dashArray: '10, 10',
                lineJoin: 'round'
            }).addTo(map);
        }

        document.getElementById('toggle-heatmap').onclick = function() {
            showHeatmap = !showHeatmap;
            if(showHeatmap) {
                heatmapLayer = L.heatLayer(heatPoints, {
                    radius: 40, blur: 25, maxZoom: 17,
                    gradient: {0.4: 'blue', 0.6: 'cyan', 0.7: 'lime', 0.8: 'yellow', 1: 'red'}
                }).addTo(map);
                this.classList.add('bg-blue-600/20', 'border-blue-400');
            } else {
                if(heatmapLayer) map.removeLayer(heatmapLayer);
                this.classList.remove('bg-blue-600/20', 'border-blue-400');
            }
        };

        document.getElementById('toggle-routes').onclick = function() {
            showRoutes = !showRoutes;
            if (showRoutes) {
                this.classList.add('bg-blue-600/20', 'border-blue-400');
                if (currentSelectedSeller) {
                    drawRoute(currentSelectedSeller);
                }
            } else {
                this.classList.remove('bg-blue-600/20', 'border-blue-400');
                if (routeLayer) map.removeLayer(routeLayer);
            }
        };

        document.getElementById('view-board').onclick = function() {
            renderSellerList('board');
            this.classList.add('bg-blue-600', 'text-white');
            document.getElementById('view-team').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('view-team').classList.add('text-slate-400');
            map.flyTo([-23.5, -46.6], 10);
        };

        document.getElementById('view-team').onclick = function() {
            renderSellerList('team');
            this.classList.add('bg-blue-600', 'text-white');
            document.getElementById('view-board').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('view-board').classList.add('text-slate-400');
            
            // Ao voltar para "Minha Equipe", reseta para Todos
            selectAllSellers(document.getElementById('btn-all-sellers'));
        };

        window.onload = initApp;
    </script>
</body>
</html>